<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tube-Programme - Votre Grille TV YouTube</title>
    
    <!-- Frameworks & Bibliothèques -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        
        :root {
            --brand-indigo: #6366f1;
            --bg-dark: #020617;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .pulse-red {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--brand-indigo);
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        /**
         * ⚠️ CONFIGURATION FIREBASE & YOUTUBE
         */
        const firebaseConfig = {
            apiKey: "AIzaSyCKamP75x_siY9MAmzQJEOiDR3JBk9n6-4",
            authDomain: "verbonautes.firebaseapp.com",
            projectId: "verbonautes",
            storageBucket: "verbonautes.firebasestorage.app",
            messagingSenderId: "578222598670",
            appId: "1:578222598670:web:4535fbec0ed7cdb26c6a5f"
        };

        // Optionnel : Pour l'importation par chaîne, vous pouvez mettre votre clé ici
        const YOUTUBE_API_KEY = "AIzaSyCL14u36vgGvG668LrKHGnCjmIR6LQhI4M"; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const isConfigured = firebaseConfig.apiKey !== "VOTRE_API_KEY";
        let db, auth;
        
        if (isConfigured) {
            const fbApp = initializeApp(firebaseConfig);
            auth = getAuth(fbApp);
            db = getFirestore(fbApp);
        }

        const APP_ID = "tube-prog-v0";
        const CATEGORIES = [
            { id: 'ia', label: 'Intelligence Artificielle', icon: 'cpu' },
            { id: 'lecture', label: 'Lecture & Livres', icon: 'book-open' },
            { id: 'foot', label: 'Football & Analyses', icon: 'trophy' },
            { id: 'interviews', label: 'Interviews & Débats', icon: 'mic-2' },
        ];

        // --- COMPOSANT : ADMIN MODAL AVEC IMPORT CHAÎNE ---

        const AdminModal = ({ onClose }) => {
            const [mode, setMode] = React.useState('manual'); // 'manual' or 'channel'
            const [ytApiKey, setYtApiKey] = React.useState(YOUTUBE_API_KEY);
            const [channelId, setChannelId] = React.useState('');
            const [channelVideos, setChannelVideos] = React.useState([]);
            const [loadingFetch, setLoadingFetch] = React.useState(false);

            const [formData, setFormData] = React.useState({
                youtubeId: '', title: '', creatorName: '', categoryId: 'ia', pitch: '', status: 'archive'
            });

            // Récupérer les vidéos d'une chaîne
            const fetchChannelVideos = async () => {
                if (!ytApiKey || !channelId) return alert("Clé API et Channel ID requis.");
                setLoadingFetch(true);
                try {
                    const response = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${ytApiKey}&channelId=${channelId}&part=snippet,id&order=date&maxResults=5&type=video`);
                    const data = await response.json();
                    if (data.items) {
                        setChannelVideos(data.items);
                    } else {
                        alert("Aucune vidéo trouvée ou erreur API.");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Erreur réseau API YouTube.");
                } finally {
                    setLoadingFetch(false);
                }
            };

            const selectFromChannel = (v) => {
                setFormData({
                    ...formData,
                    youtubeId: v.id.videoId,
                    title: v.snippet.title,
                    creatorName: v.snippet.channelTitle,
                });
                setMode('manual');
            };

            const save = async (e) => {
                e.preventDefault();
                try {
                    const id = crypto.randomUUID();
                    const docRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'programs', id);
                    await setDoc(docRef, { ...formData, id, avgScore: 0, createdAt: Date.now() });
                    onClose();
                } catch (err) { alert("Erreur Firebase."); }
            };

            return (
                <div className="fixed inset-0 z-[100] bg-slate-950/95 backdrop-blur-xl flex items-center justify-center p-4">
                    <div className="bg-slate-900 border border-slate-800 w-full max-w-2xl rounded-[2.5rem] p-10 shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-8">
                            <h2 className="text-2xl font-black text-white uppercase italic tracking-tighter">Curation Administrateur</h2>
                            <button onClick={onClose} className="text-slate-500 hover:text-white transition-colors"><i data-lucide="x"></i></button>
                        </div>

                        <div className="flex gap-4 mb-8 bg-slate-800/50 p-1.5 rounded-2xl">
                            <button onClick={() => setMode('manual')} className={`flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${mode === 'manual' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>Saisie Manuelle</button>
                            <button onClick={() => setMode('channel')} className={`flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${mode === 'channel' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:text-slate-300'}`}>Import par Chaîne</button>
                        </div>

                        {mode === 'channel' ? (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black text-slate-500 uppercase">Clé API YouTube Data V3</label>
                                        <input type="password" className="w-full bg-slate-800 p-4 rounded-2xl text-sm" placeholder="Votre Clé API Google Cloud..." value={ytApiKey} onChange={e => setYtApiKey(e.target.value)} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black text-slate-500 uppercase">ID de la Chaîne (ex: UC...)</label>
                                        <div className="flex gap-3">
                                            <input className="flex-1 bg-slate-800 p-4 rounded-2xl text-sm" placeholder="UChv..." value={channelId} onChange={e => setChannelId(e.target.value)} />
                                            <button onClick={fetchChannelVideos} disabled={loadingFetch} className="bg-indigo-600 px-6 rounded-2xl font-bold hover:bg-indigo-500 disabled:opacity-50 transition-all">
                                                {loadingFetch ? "..." : "Chercher"}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    {channelVideos.map((v, i) => (
                                        <div key={i} onClick={() => selectFromChannel(v)} className="flex items-center gap-4 bg-slate-800/30 p-3 rounded-2xl border border-slate-800 hover:border-indigo-500/50 cursor-pointer transition-all group">
                                            <img src={v.snippet.thumbnails.default.url} className="w-20 rounded-xl" />
                                            <div className="flex-1 min-w-0">
                                                <h4 className="text-sm font-bold text-white truncate group-hover:text-indigo-400">{v.snippet.title}</h4>
                                                <p className="text-[10px] text-slate-500 uppercase font-black">{v.snippet.channelTitle}</p>
                                            </div>
                                            <div className="text-indigo-400"><i data-lucide="plus-circle" className="w-5 h-5"></i></div>
                                        </div>
                                    ))}
                                    {channelVideos.length === 0 && !loadingFetch && (
                                        <p className="text-center text-slate-600 text-xs italic py-10">Entrez un ID de chaîne pour voir les dernières vidéos.</p>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <form onSubmit={save} className="space-y-6 animate-in fade-in slide-in-from-bottom-2 duration-300">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black text-slate-500 uppercase">ID Vidéo</label>
                                        <input required className="w-full bg-slate-800 p-4 rounded-2xl text-sm" placeholder="ex: dQw4w9WgXcQ" value={formData.youtubeId} onChange={e => setFormData({...formData, youtubeId: e.target.value})} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-[10px] font-black text-slate-500 uppercase">Thème</label>
                                        <select className="w-full bg-slate-800 p-4 rounded-2xl text-sm" value={formData.categoryId} onChange={e => setFormData({...formData, categoryId: e.target.value})}>
                                            {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase">Créateur</label>
                                    <input required className="w-full bg-slate-800 p-4 rounded-2xl text-sm" placeholder="ex: Henri ExplorIA" value={formData.creatorName} onChange={e => setFormData({...formData, creatorName: e.target.value})} />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase">Titre</label>
                                    <input required className="w-full bg-slate-800 p-4 rounded-2xl text-sm" placeholder="Titre du programme..." value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase">Pitch (140 car.)</label>
                                    <textarea required maxLength={140} className="w-full bg-slate-800 p-4 rounded-2xl text-sm h-24" placeholder="Pourquoi est-ce une pépite ?" value={formData.pitch} onChange={e => setFormData({...formData, pitch: e.target.value})} />
                                </div>
                                <button type="submit" className="w-full py-5 bg-indigo-600 hover:bg-indigo-500 text-white font-black rounded-2xl uppercase tracking-widest transition-all">Publier</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        // --- APPLICATION PRINCIPALE ---

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [programs, setPrograms] = React.useState([]);
            const [activeTab, setActiveTab] = React.useState('accueil');
            const [selectedProg, setSelectedProg] = React.useState(null);
            const [isAdminOpen, setIsAdminOpen] = React.useState(false);

            if (!isConfigured) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-8 text-center bg-slate-950">
                        <div className="max-w-md bg-slate-900 p-12 rounded-[3rem] border border-indigo-500/20 shadow-2xl">
                            <h2 className="text-2xl font-black mb-6 italic uppercase tracking-tighter">Configuration Requise</h2>
                            <p className="text-slate-400 text-sm mb-8 leading-relaxed">Insérez vos clés Firebase dans le code pour activer la grille de programmes.</p>
                            <a href="https://console.firebase.google.com" target="_blank" className="inline-block bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black text-sm uppercase">Ouvrir Firebase</a>
                        </div>
                    </div>
                );
            }

            React.useEffect(() => {
                signInAnonymously(auth);
                onAuthStateChanged(auth, setUser);
            }, []);

            React.useEffect(() => {
                if (!user) return;
                const q = collection(db, 'artifacts', APP_ID, 'public', 'data', 'programs');
                const unsub = onSnapshot(q, (snap) => {
                    setPrograms(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setTimeout(() => window.lucide.createIcons(), 100);
                });
                return () => unsub();
            }, [user]);

            const deleteProg = async (id) => {
                if (confirm("Supprimer ce programme ?")) {
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'programs', id));
                }
            };

            const filtered = activeTab === 'accueil' ? programs : programs.filter(p => p.categoryId === activeTab);

            return (
                <div className="min-h-screen flex">
                    {/* Sidebar */}
                    <aside className="w-72 bg-slate-950/80 backdrop-blur-xl border-r border-slate-800/40 fixed h-full flex flex-col z-50">
                        <div className="p-10 flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-600/20">
                                <i data-lucide="sparkles" className="text-white w-5 h-5"></i>
                            </div>
                            <h1 className="text-xl font-black uppercase italic tracking-tighter">Tube<span className="text-indigo-500">Prog</span></h1>
                        </div>
                        
                        <nav className="flex-1 px-4 space-y-1">
                            <button onClick={() => setActiveTab('accueil')} className={`w-full flex items-center gap-3 px-5 py-4 rounded-2xl transition-all ${activeTab === 'accueil' ? 'bg-indigo-600/20 text-indigo-400 font-bold' : 'text-slate-400 hover:bg-slate-800/30'}`}>
                                <i data-lucide="layout-grid" className="w-4 h-4"></i> <span className="text-sm">Ma Grille Hebdo</span>
                            </button>
                            <div className="mt-10 mb-4 px-5 text-[10px] font-black text-slate-600 uppercase tracking-[0.2em]">Thématiques</div>
                            {CATEGORIES.map(cat => (
                                <button key={cat.id} onClick={() => setActiveTab(cat.id)} className={`w-full flex items-center gap-3 px-5 py-4 rounded-2xl transition-all ${activeTab === cat.id ? 'bg-indigo-600/20 text-indigo-400 font-bold' : 'text-slate-400 hover:bg-slate-800/30'}`}>
                                    <i data-lucide={cat.icon} className="w-4 h-4"></i> <span className="text-sm">{cat.label}</span>
                                </button>
                            ))}
                        </nav>

                        <div className="p-8">
                            <button onClick={() => setIsAdminOpen(true)} className="w-full py-4 bg-slate-900 border border-slate-800 rounded-2xl text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-indigo-400 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="lock" className="w-3 h-3"></i> Admin Curation
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="ml-72 flex-1 p-12">
                        <header className="mb-16">
                            <h2 className="text-6xl font-black text-white uppercase italic leading-none mb-4">
                                {activeTab === 'accueil' ? "À l'affiche" : CATEGORIES.find(c => c.id === activeTab).label}
                            </h2>
                            <p className="text-slate-500 font-medium text-lg italic tracking-tight underline decoration-indigo-500/30 underline-offset-4">La sélection prioritaire de la semaine.</p>
                        </header>

                        <div className="flex gap-10 overflow-x-auto pb-20 no-scrollbar">
                            {filtered.length > 0 ? filtered.map(prog => (
                                <div key={prog.id} onClick={() => setSelectedProg(prog)} className="flex-shrink-0 w-80 group cursor-pointer animate-in fade-in zoom-in-95 duration-500">
                                    <div className="relative aspect-video rounded-3xl overflow-hidden border border-slate-800 group-hover:border-indigo-500/50 transition-all duration-500 shadow-2xl">
                                        <img src={`https://img.youtube.com/vi/${prog.youtubeId}/maxresdefault.jpg`} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />
                                        <div className="absolute inset-0 bg-gradient-to-t from-slate-950/80 via-transparent to-transparent opacity-60" />
                                        <button onClick={(e) => { e.stopPropagation(); deleteProg(prog.id); }} className="absolute top-4 right-4 p-2 bg-red-600 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:scale-110"><i data-lucide="trash-2" className="w-3 h-3 text-white"></i></button>
                                        <div className="absolute bottom-4 right-4 bg-slate-950/80 backdrop-blur-md border border-white/10 px-2 py-1 rounded-lg text-[10px] text-indigo-300 font-bold uppercase">★ {prog.avgScore?.toFixed(1) || "N/A"}</div>
                                    </div>
                                    <div className="mt-6 px-1">
                                        <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2">{prog.creatorName}</span>
                                        <h3 className="text-lg font-bold text-white leading-tight group-hover:text-indigo-400 transition-colors line-clamp-2 italic tracking-tighter">{prog.title}</h3>
                                        <p className="text-slate-500 text-xs mt-3 line-clamp-2 italic border-l-2 border-slate-800 pl-4 leading-relaxed">"{prog.pitch}"</p>
                                    </div>
                                </div>
                            )) : (
                                <div className="w-full border-2 border-dashed border-slate-800 rounded-[3rem] p-32 text-center">
                                    <p className="text-slate-600 font-black uppercase tracking-widest text-xs mb-6">Votre grille est vide.</p>
                                    <button onClick={() => setIsAdminOpen(true)} className="text-indigo-400 font-black uppercase italic underline decoration-2 underline-offset-8 transition-all hover:text-white">Ajouter un programme →</button>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Full Player Modal */}
                    {selectedProg && (
                        <div className="fixed inset-0 z-[60] bg-slate-950/98 backdrop-blur-3xl flex items-center justify-center p-12">
                            <button onClick={() => setSelectedProg(null)} className="absolute top-10 right-10 text-slate-500 border border-slate-800 px-8 py-3 rounded-full uppercase text-[10px] font-black tracking-widest hover:text-white transition-all hover:bg-white/5">Fermer [X]</button>
                            <div className="max-w-6xl w-full grid grid-cols-3 gap-20 items-center">
                                <div className="col-span-2 aspect-video bg-black rounded-[3rem] overflow-hidden shadow-2xl border border-white/5 shadow-indigo-500/10">
                                    <iframe width="100%" height="100%" src={`https://www.youtube.com/embed/${selectedProg.youtubeId}?autoplay=1`} frameBorder="0" allowFullScreen></iframe>
                                </div>
                                <div className="col-span-1">
                                    <span className="text-indigo-400 font-black text-[10px] uppercase tracking-widest bg-indigo-500/10 px-4 py-1.5 rounded-full mb-8 inline-block italic">{selectedProg.creatorName}</span>
                                    <h2 className="text-5xl font-black text-white leading-[1.1] mb-8 italic tracking-tighter">{selectedProg.title}</h2>
                                    <p className="text-slate-400 italic text-xl leading-relaxed border-l-4 border-indigo-500/50 pl-8 mb-12">"{selectedProg.pitch}"</p>
                                    <button className="w-full bg-white text-slate-950 py-5 rounded-[1.5rem] font-black text-sm uppercase tracking-widest hover:bg-indigo-400 transition-all flex items-center justify-center gap-3 shadow-xl italic">
                                        <i data-lucide="star" className="w-4 h-4"></i> Évaluer le programme
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isAdminOpen && <AdminModal onClose={() => setIsAdminOpen(false)} userId={user?.uid} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
